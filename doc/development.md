# Development

## Environments

| Environment | Branch | Firebase project   | Android package name      | Apple bundle ID           |
|-------------|--------|--------------------|---------------------------|---------------------------|
| dev         | main   | bedtime-writer-dev | com.tap.bedtimewriter.dev | com.tap.bedtimewriter.dev |
| prod        | prod   | bedtime-writer     | com.tap.bedtimewriter     | com.tap.bedtimewriter     |

New features are first merged into `main` and tested on the dev environment. When it's time for a
new release, `main` is merged into `prod` and a new
[Git tag](https://git-scm.com/book/en/v2/Git-Basics-Tagging) is created.

Note: we used to have a `bedtime-writer-prod` Firebase project, but it was almost never used, and
has been deleted.

### Switch between environments

1. Select the right Firebase project (`bedtime-writer` for production, `bedtime-writer-dev` for
   development): `firebase use <project-id>`.
2. Build the functions: `npm run build:watch`.
3. If needed, run the local backend `npm run local_backend`. Note: run the Firebase emulators
   before launching the Android emulator, as some ports may conflict.
4. If you want to deploy to the remote servers, use `npm run deploy_functions`.
5. Finally run (or build) the app: `flutter run --flavor <env> -d <device-emulator-id>`.

### Create and maintain an environment

#### Create a Firebase project

This should be mostly straightforward. Read or edit the table above for the Android package name and
Apple bundle ID. If needed, here are some default values:
* Default GCP resource location: europe-west6
* Users and permissions: add Pierre and Tristan as owners
* Upgrade the Firebase billing plan to "Blaze"

#### Update the code

1. Create [a new Flutter flavor](https://docs.flutter.dev/deployment/flavors) for it.
2. Android: add the `google-services.json` corresponding to your flavor to the `android/<flavor>`
   folder.
3. Select the new Firebase project: `firebase use <project-id>`.
4. Generate the options file `firebase_options.dart` for Firebase:
   `flutterfire configure -p <project-id> -a <android_package_name>`. Sometimes, this has to be
   done again, such as when a new service is added to the project. Explanations: -p specifies the
   Firebase project, -a specifies the Android package name (see table above). For iOS, use -i.
5. Finally, remove the `android/app/google-services.json` file that may have been generated by the
   last command.

Finally, we suggest to take a look at [Deployment](./deployment.md), as it contains all the services
needed by the code in any environment.

## Line separators

Line separators should always be LF. On Unix and macOS, you have nothing to do. On Windows, ensure
that `git config --local core.autocrlf` is `false`, and use an editor that can use LF. The
`.gitattributes` file should ensure that Git always uses LF. You might have to [refresh your
repository](https://docs.github.com/en/get-started/getting-started-with-git/configuring-git-to-handle-line-endings#refreshing-a-repository-after-changing-line-endings).

## Code organization

* `lib/`: contains the Flutter code
    * `feature_name/`: everything related to a specific feature
        * `screens/`: screens and related widgets
        * `states/`: states and logic attached to them
        * `index.start`: should reexport the screens
    * `backend/`: contains calls to the backend (auth, database, etc.)
    * `widgets/`: contains widgets that are reused across screens
    * `main.dart`: entry point of the application
    * `router.dart`: the routes of the application
    * `theme.dart`: the theme for the entire application
